<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.t4l2.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="0. 引言在KubeEdge中，mapper组件是边缘设备与边缘节点之间的桥梁。Mapper从边缘设备中采集设备数据，并通过Mqtt的形式将数据传递给Mqtt Broker，并通过EventBus进入边缘节点。因此，对于不同的边缘设备，也需要不同的mapper进行数据采集。社区目前已经提供了两种比较通用的mapper组件，分别支持蓝牙协议和modbus协议，这都是边缘设备中比较常见的协议。本文将对">
<meta property="og:type" content="article">
<meta property="og:title" content="KubeEdge源码分析之BluetoothMapper">
<meta property="og:url" content="http:&#x2F;&#x2F;www.t4l2.com&#x2F;2020-05-19-KubeEdge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BBluetoothMapper.html">
<meta property="og:site_name" content="T4L2">
<meta property="og:description" content="0. 引言在KubeEdge中，mapper组件是边缘设备与边缘节点之间的桥梁。Mapper从边缘设备中采集设备数据，并通过Mqtt的形式将数据传递给Mqtt Broker，并通过EventBus进入边缘节点。因此，对于不同的边缘设备，也需要不同的mapper进行数据采集。社区目前已经提供了两种比较通用的mapper组件，分别支持蓝牙协议和modbus协议，这都是边缘设备中比较常见的协议。本文将对">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-19T07:18:35.000Z">
<meta property="article:modified_time" content="2020-05-29T08:32:54.875Z">
<meta property="article:author" content="RongAI">
<meta property="article:tag" content="kubeedge">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://www.t4l2.com/2020-05-19-KubeEdge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BBluetoothMapper.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>KubeEdge源码分析之BluetoothMapper | T4L2</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">T4L2</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Time to learn for everything</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.t4l2.com/2020-05-19-KubeEdge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BBluetoothMapper.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="RongAI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="T4L2">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          KubeEdge源码分析之BluetoothMapper
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-19 15:18:35" itemprop="dateCreated datePublished" datetime="2020-05-19T15:18:35+08:00">2020-05-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubeedge/" itemprop="url" rel="index"><span itemprop="name">kubeedge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="0-引言"><a href="#0-引言" class="headerlink" title="0. 引言"></a>0. 引言</h4><p>在KubeEdge中，mapper组件是边缘设备与边缘节点之间的桥梁。Mapper从边缘设备中采集设备数据，并通过Mqtt的形式将数据传递给Mqtt Broker，并通过EventBus进入边缘节点。因此，对于不同的边缘设备，也需要不同的mapper进行数据采集。社区目前已经提供了两种比较通用的mapper组件，分别支持蓝牙协议和modbus协议，这都是边缘设备中比较常见的协议。本文将对支持蓝牙协议的mapper进行分析，并结合社区CC2560 Sensortag的例子加以说明。</p>
<p><em>注：由于BluetoothMapper和demo都有些时间没有维护了，笔者在实践过程中也有许多不解之处，如有疑问欢迎与我交流。</em></p>
<a id="more"></a>

<h4 id="1-整体分析"><a href="#1-整体分析" class="headerlink" title="1. 整体分析"></a>1. 整体分析</h4><p>Bluetooth Mapper主要包含以下5个组件：</p>
<ul>
<li>Action Manager 动作管理器</li>
<li>Scheduler 调度器</li>
<li>Watcher 监视器</li>
<li>Controller 控制器</li>
<li>Data Converter 数据转换器</li>
</ul>
<p>其中控制器起到统领全局的作用，可以控制其他组件。我们将在下面遇到的时候加以介绍。</p>
<h4 id="2-Main-函数"><a href="#2-Main-函数" class="headerlink" title="2. Main()函数"></a>2. Main()函数</h4><p>首先要从mapper的main函数看起：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 1、初始化日志等杂项</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	klog.InitFlags(<span class="literal">nil</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	pflag.CommandLine.AddGoFlagSet(flag.CommandLine)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	pflag.Parse()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 2、初始化配置文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	BleConfig := configuration.BLEConfig&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	err := BleConfig.Load()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">		klog.Errorf(<span class="string">"Error in loading configuration: %s"</span>, err)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">		os.Exit(<span class="number">1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 3、初始化控制器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	bleController := controller.Config&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">		Watcher:       BleConfig.Watcher,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">		ActionManager: BleConfig.ActionManager,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">		Scheduler:     BleConfig.Scheduler,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">		Converter:     BleConfig.Converter,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">		Device:        BleConfig.Device,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">		Mqtt:          BleConfig.Mqtt,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 4、启动控制器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">	bleController.Start()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>main()函数里主要做的就是将相关配置保存到一个BleConfig里，基于其来实例化bleController控制器并启动。Mapper即可连接设备、接收数据并传输给Mqtt Broker。</p>
<h5 id="2-1-BleConfig结构"><a href="#2-1-BleConfig结构" class="headerlink" title="2.1. BleConfig结构"></a>2.1. BleConfig结构</h5><p>首先来看BleConfig的结构，它和blecontroller的成员是一致的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BLEConfig <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">   Mqtt          Mqtt                        <span class="string">`yaml:"mqtt"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   Device        Device                      <span class="string">`yaml:"device"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   Watcher       watcher.Watcher             <span class="string">`yaml:"watcher"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   Scheduler     scheduler.Scheduler         <span class="string">`yaml:"scheduler"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   ActionManager actionmanager.ActionManager <span class="string">`yaml:"action-manager"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   Converter     dataconverter.Converter     <span class="string">`yaml:"data-converter"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>其中，BLE（Bluetooth Low Energy）指的是低功耗蓝牙的意思，在边缘设备中比较常用。</p>
<h6 id="2-1-1-ActionManager"><a href="#2-1-1-ActionManager" class="headerlink" title="2.1.1. ActionManager"></a>2.1.1. ActionManager</h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ActionManager <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    Actions []Action <span class="string">`yaml:"actions"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Action <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    PerformImmediately <span class="keyword">bool</span>      <span class="string">`yaml:"perform-immediately" json:"perform-immediately"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    Name               <span class="keyword">string</span>    <span class="string">`yaml:"name" json:"name"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    Operation          Operation <span class="string">`yaml:"operation" json:"operation"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Operation <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    Action             <span class="keyword">string</span> <span class="string">`yaml:"action" json:"action"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    CharacteristicUUID <span class="keyword">string</span> <span class="string">`yaml:"characteristic-uuid" json:"characteristic-uuid"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    Value              []<span class="keyword">byte</span> <span class="string">`yaml:"value" json:"value"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>ActionManager组件主要用于管理“动作”。其中Action主要用来定义动作，每个设备可以有多个这样的动作，每个动作对应设备的一组读/写操作。一个蓝牙设备可以通过向其物理寄存器写入特定值来控制，并从特定寄存器来读取数据。这些寄存器通过特征值（characteristic values）标示分辨，并以UUID的形式公开这些特征值。这些动作都需要通过config文件提供给ActionManage，而且这些在配置文件里的初始值可以通过Mqtt发布修改。各成员含义如下：</p>
<ul>
<li>ActionManager.Actions：动作数组，其中的每个动作都可以由ActionManager控制执行，或者由schedular和watcher调用</li>
<li>Action.Name：动作名称，每个动作名称需要唯一</li>
<li>Action.PerformImmediately：立即执行，为true则ActionManager会立即执行动作一次</li>
<li>Action.Operation.Action：真正执行的动作，分为READ和WRITE</li>
<li>Action.Operation.CharacteristicUUID：唯一确定要进行读写操作的设备寄存器</li>
<li>Action.Operation.Value：读到的值或要写入的值</li>
</ul>
<h6 id="2-1-2-Scheduler"><a href="#2-1-2-Scheduler" class="headerlink" title="2.1.2. Scheduler"></a>2.1.2. Scheduler</h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Scheduler <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    Schedules []Schedule <span class="string">`yaml:"schedules" json:"schedules"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Schedule <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    Name            <span class="keyword">string</span>   <span class="string">`yaml:"name" json:"name"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    Interval        <span class="keyword">int</span>      <span class="string">`yaml:"interval" json:"interval"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    OccurrenceLimit <span class="keyword">int</span>      <span class="string">`yaml:"occurrence-limit" json:"occurrence-limit"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    Actions         []<span class="keyword">string</span> <span class="string">`yaml:"actions"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>Schedular组件用于控制mapper按固定时间间隔执行一个或一组动作，属于可选模块。用户可以通过配置文件提供数组来定义多个schedular。schedular字段的具体各个字段如下：</p>
<ul>
<li>Schedule.Name：名称，要求唯一</li>
<li>Schedule.Interval：时间间隔，以ms为单位</li>
<li>Schedule.OccurrenceLimit：执行次数，0值则无限执行</li>
<li>Schedule.Actions：即计划执行的动作序列名称，有序执行</li>
</ul>
<h6 id="2-1-3-Watcher"><a href="#2-1-3-Watcher" class="headerlink" title="2.1.3. Watcher"></a>2.1.3. Watcher</h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Watcher <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    DeviceTwinAttributes []Attribute <span class="string">`yaml:"device-twin-attributes" json:"device-twin-attributes"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Attribute <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    Name    <span class="keyword">string</span>   <span class="string">`yaml:"device-property-name" json:"device-property-name"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    Actions []<span class="keyword">string</span> <span class="string">`yaml:"actions" json:"actions"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>Watcher组件的指职责主要是：扫描蓝牙设备并连接到正确的设备；监视设备的双属性预期状态，并执行使实际状态与预期相等的动作；将双属性的实际状态报告给云端。这也是一个可选组件，watcher字段的具体各个字段如下：</p>
<ul>
<li>Attribute.Name：设备属性名称（<del>注：请注意property和attribute两个“属性”的区别，前者是我们需要读写的设备属性，后者是指蓝牙协议中一条带有标签的、可以被寻址的数据</del>），创建设备时给定的设备双属性名称。观察者使用此名称监视预期状态的任何更改</li>
<li>Attribute.Actions：动作数组，通过它们将实际状态转化为预期状态，有序</li>
</ul>
<p>另外，以上三者的配置在运行时都可以通过向mqtt发布消息来进行更改，具体消发布格式可见官方文档。</p>
<h6 id="2-1-4-Converter"><a href="#2-1-4-Converter" class="headerlink" title="2.1.4. Converter"></a>2.1.4. Converter</h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Converter是保存数据转换特定配置的结构</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Converter <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   DataWrite DataWrite <span class="string">`yaml:"write"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   DataRead  DataRead  <span class="string">`yaml:"read"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>数据转换器的结构中主要包含两部分，数据的写入和读取。其中数据写入部分的结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//dataWrite结构保存特定的数据写入的配置信息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DataWrite <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   Attributes []WriteAttribute <span class="string">`yaml:"attributes"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//WriteAttribute保存属性的名称以及要写入的值的DataMap</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WriteAttribute <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	Name       <span class="keyword">string</span>             <span class="string">`yaml:"name"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	Operations <span class="keyword">map</span>[<span class="keyword">string</span>]DataMap <span class="string">`yaml:"operations"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//DataMap 结构保存期望值和要写入设备字节值的map</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DataMap <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">	DataMapping <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span> <span class="string">`yaml:"data-map"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>数据读取部分的结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//dataRead结构保存特定的数据读取的配置信息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DataRead <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	Actions []ReadAction <span class="string">`yaml:"actions"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ReadAction保存动作名称以及读取数据的转换操作</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ReadAction <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	ActionName          <span class="keyword">string</span>        <span class="string">`yaml:"action-name"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	ConversionOperation ReadOperation <span class="string">`yaml:"conversion-operation"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ReadOperation指定如何将从设备接收的数据转换为有意义的数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ReadOperation <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">	StartIndex       <span class="keyword">int</span>      <span class="string">`yaml:"start-index"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	EndIndex         <span class="keyword">int</span>      <span class="string">`yaml:"end-index"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	ShiftLeft        <span class="keyword">uint</span>     <span class="string">`yaml:"shift-left"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">	ShiftRight       <span class="keyword">uint</span>     <span class="string">`yaml:"shift-right"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	Multiply         <span class="keyword">float64</span>  <span class="string">`yaml:"multiply"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">	Divide           <span class="keyword">float64</span>  <span class="string">`yaml:"divide"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">	Add              <span class="keyword">float64</span>  <span class="string">`yaml:"add"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	Subtract         <span class="keyword">float64</span>  <span class="string">`yaml:"subtract"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">	OrderOfExecution []<span class="keyword">string</span> <span class="string">`yaml:"order-of-execution"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h6 id="2-1-5-Device"><a href="#2-1-5-Device" class="headerlink" title="2.1.5. Device"></a>2.1.5. Device</h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Device <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">   ID   <span class="keyword">string</span> <span class="string">`yaml:"id"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   Name <span class="keyword">string</span> <span class="string">`yaml:"name"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>Device结构比较简单，仅保存了设备的ID和名称。</p>
<h6 id="2-1-6-Mqtt"><a href="#2-1-6-Mqtt" class="headerlink" title="2.1.6. Mqtt"></a>2.1.6. Mqtt</h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Mqtt <span class="keyword">struct</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">   Mode           <span class="keyword">int</span>    <span class="string">`yaml:"mode"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   InternalServer <span class="keyword">string</span> <span class="string">`yaml:"internal-server"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   Server         <span class="keyword">string</span> <span class="string">`yaml:"server"`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>Mqtt(消息队列遥测传输)是ISO 标准下基于发布/订阅范式的消息协议，本文不对Mqtt多加介绍。Mqtt协议有两种模式，分别是internal模式和external模式，分别用于内部通信和设备连接。</p>
<h5 id="2-2-Load函数（一）"><a href="#2-2-Load函数（一）" class="headerlink" title="2.2. Load函数（一）"></a>2.2. Load函数（一）</h5><p>接下来看Load函数，该函数非常长，主要是实例化BleConfig的各个成员，除了ActionManager以外的成员的初始化都比较直接：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Load is used to consolidate the information loaded from the configuration file and the configmaps</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BLEConfig)</span> <span class="title">Load</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 1、从目录中读取配置文件和configmap文件，后者运行时才创建</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	readConfigFile := ReadConfigFile&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	readConfigMap := DeviceProfile&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	err := readConfigFile.ReadFromConfigFile()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"Error while reading from configuration file "</span> + err.Error())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	err = readConfigMap.ReadFromConfigMap()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"Error while reading from config map "</span> + err.Error())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 2-1、根据配置文件初始化BleConfig的Mqtt、Schedular和Watcher</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	b.Mqtt = readConfigFile.Mqtt</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	b.Scheduler = readConfigFile.Scheduler</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">	b.Watcher = readConfigFile.Watcher</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">// 2-2、根据configmap初始化BleConfig的Device</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span> _, device := <span class="keyword">range</span> readConfigMap.DeviceInstances &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">if</span> strings.EqualFold(device.Model, readConfigFile.DeviceModelName) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">			b.Device.ID = device.ID</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">			b.Device.Name = device.Model</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">// 2-3、初始化BleConfig的ActionManager（重点）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> _, actionConfig := <span class="keyword">range</span> readConfigFile.ActionManager.Actions &#123;...&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">	Config = b</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>最后的Config是一个全局变量。在看初始化ACtionManager的代码前，先看一下这里面用到的两个文件路径：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConfigFilePath contains the location of the configuration file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ConfigFilePath = <span class="string">"configuration/config.yaml"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConfigMapPath contains the location of the configuration file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ConfigMapPath = <span class="string">"/opt/kubeedge/deviceProfile.json"</span></span></pre></td></tr></table></figure>

<p>前者，配置文件，对于每一个设备，用户都要自己构建一个config.yaml，放到bluetoothmapper中用于创建对应设备mapper的Dockerfile，用来定义动作、调度器和监视器。我们以CC2650为例来看一下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="attr">mqtt:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="attr">mode:</span> <span class="number">0</span>       <span class="comment"># 0 -internal mqtt broker  1 - external mqtt broker</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="attr">server:</span> <span class="string">tcp://127.0.0.1:1883</span> <span class="comment"># external mqtt broker url.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="attr">internal-server:</span> <span class="string">tcp://127.0.0.1:1884</span> <span class="comment"># internal mqtt broker url.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="attr">device-model-name:</span> <span class="string">cc2650-sensortag</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="attr">action-manager:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  <span class="attr">actions:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IRTemperatureConfiguration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">perform-immediately:</span> <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">device-property-name:</span> <span class="string">temperature-enable</span>     <span class="comment">#property-name defined in the device model</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IRTemperatureData</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">perform-immediately:</span> <span class="literal">false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">device-property-name:</span> <span class="string">temperature</span>            <span class="comment">#property-name defined in the device model</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IOConfigurationInitialize</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">perform-immediately:</span> <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">device-property-name:</span> <span class="string">io-config-initialize</span>    <span class="comment">#property-name defined in the device model</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IODataInitialize</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">perform-immediately:</span> <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">device-property-name:</span> <span class="string">io-data-initialize</span>      <span class="comment">#property-name defined in the device model</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IOConfiguration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">perform-immediately:</span> <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">device-property-name:</span> <span class="string">io-config</span>                <span class="comment">#property-name defined in the device model</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IOData</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">perform-immediately:</span> <span class="literal">false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">device-property-name:</span> <span class="string">io-data</span>                  <span class="comment">#property-name defined in the device model</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="attr">scheduler:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  <span class="attr">schedules:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">temperature</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">interval:</span> <span class="number">3000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">occurrence-limit:</span> <span class="number">10</span>            <span class="comment"># if it is 0, then the event will execute infinitely</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">actions:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        <span class="bullet">-</span> <span class="string">IRTemperatureData</span>          <span class="comment"># Action name defined in the action-manager section</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"><span class="attr">watcher:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">  <span class="attr">device-twin-attributes :</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">device-property-name:</span> <span class="string">io-data</span>                     <span class="comment"># the twin attribute name defined while creating device</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">      <span class="attr">actions:</span>                         <span class="comment"># list of action names, defined in the action-manager section, to be executed on the device</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        <span class="bullet">-</span> <span class="string">IOConfigurationInitialize</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        <span class="bullet">-</span> <span class="string">IODataInitialize</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        <span class="bullet">-</span> <span class="string">IOConfiguration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        <span class="bullet">-</span> <span class="string">IOData</span></span></pre></td></tr></table></figure>

<p>其首先定义了mqtt的属性和对应的设备模型，即使用cc2650-sensortag的设备模型，接着定义了各个动作，并且由调度器每3s读取红外温度1次，由监视器控制io-data，即CC2650的红灯、绿灯和蜂鸣器，具体怎么监控后面来讲。</p>
<p>后者，configmap文件，是运行后创建的，比照数据可见其是依据device和devicemodel创建的，具体来说，当device创建时，设备控制器的下行控制器会将其各个属性保存在一个名为device-profile-config-&lt;nodename&gt;的ConfigMap中，而mapper就是通过读取这个configmap来获取到这些信息的。我们可以通过如下命令进入容器来查看这个文件：</p>
<p><code># docker exec -it &lt;docker id&gt; /bin/sh</code></p>
<p><code># cat /opt/kubeedge/deviceProfile.json</code></p>
<p>这里以笔者边缘节点的deviceProfile.json文件为例，连接了CC2650-Sensortag和温度传感器两个设备：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="attr">"deviceInstances"</span>: [&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"id"</span>: <span class="string">"temperature"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"temperature"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"model"</span>: <span class="string">"temperature-model"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"id"</span>: <span class="string">"sensor-tag-instance-01"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"sensor-tag-instance-01"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol"</span>: <span class="string">"bluetooth-sensor-tag-instance-01"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"model"</span>: <span class="string">"cc2650-sen"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">	&#125;],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">	<span class="attr">"deviceModels"</span>: [&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"temperature-model"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"properties"</span>: [&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"name"</span>: <span class="string">"temperature-status"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataType"</span>: <span class="string">"string"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"description"</span>: <span class="string">"Temperature collected from the edge device"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"accessMode"</span>: <span class="string">"ReadOnly"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"defaultValue"</span>: <span class="string">""</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">		&#125;]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"cc2650-sen"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"properties"</span>: [&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"name"</span>: <span class="string">"temperature"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataType"</span>: <span class="string">"int"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"description"</span>: <span class="string">"temperature in degree celsius"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"accessMode"</span>: <span class="string">"ReadOnly"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"defaultValue"</span>: <span class="number">0</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"maximum"</span>: <span class="number">100</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"unit"</span>: <span class="string">"degree celsius"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">		&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"name"</span>: <span class="string">"temperature-enable"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataType"</span>: <span class="string">"string"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"description"</span>: <span class="string">"enable data collection of temperature sensor"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"accessMode"</span>: <span class="string">"ReadWrite"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"defaultValue"</span>: <span class="string">"ON"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">		&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"name"</span>: <span class="string">"io-config-initialize"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataType"</span>: <span class="string">"int"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"description"</span>: <span class="string">"initialize io-config with value 0"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"accessMode"</span>: <span class="string">"ReadWrite"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"defaultValue"</span>: <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">		&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"name"</span>: <span class="string">"io-data-initialize"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataType"</span>: <span class="string">"int"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"description"</span>: <span class="string">"initialize io-data with value 0"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"accessMode"</span>: <span class="string">"ReadWrite"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"defaultValue"</span>: <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">		&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"name"</span>: <span class="string">"io-config"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataType"</span>: <span class="string">"int"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"description"</span>: <span class="string">"register activation of io-config"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"accessMode"</span>: <span class="string">"ReadWrite"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"defaultValue"</span>: <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">		&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"name"</span>: <span class="string">"io-data"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataType"</span>: <span class="string">"int"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"description"</span>: <span class="string">"data field to control io-control"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"accessMode"</span>: <span class="string">"ReadWrite"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"defaultValue"</span>: <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">		&#125;]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">	&#125;],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">	<span class="attr">"protocols"</span>: [&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"bluetooth-sensor-tag-instance-01"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol"</span>: <span class="string">"bluetooth"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol_config"</span>: &#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">	&#125;],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">	<span class="attr">"propertyVisitors"</span>: [&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"temperature"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"propertyName"</span>: <span class="string">"temperature"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"modelName"</span>: <span class="string">"cc2650-sen"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol"</span>: <span class="string">"bluetooth"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"visitorConfig"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"characteristicUUID"</span>: <span class="string">"f000aa0104514000b000000000000000"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataConverter"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"startIndex"</span>: <span class="number">1</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"shiftRight"</span>: <span class="number">2</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"orderOfOperations"</span>: [&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">					<span class="attr">"operationType"</span>: <span class="string">"Multiply"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">					<span class="attr">"operationValue"</span>: <span class="number">0.03125</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">				&#125;]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">			&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">	&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"temperature-enable"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"propertyName"</span>: <span class="string">"temperature-enable"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"modelName"</span>: <span class="string">"cc2650-sen"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol"</span>: <span class="string">"bluetooth"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"visitorConfig"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"characteristicUUID"</span>: <span class="string">"f000aa0204514000b000000000000000"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataWrite"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"OFF"</span>: <span class="string">"AA=="</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"ON"</span>: <span class="string">"AQ=="</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">			&#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataConverter"</span>: &#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">	&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"io-config-initialize"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"propertyName"</span>: <span class="string">"io-config-initialize"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">100</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"modelName"</span>: <span class="string">"cc2650-sen"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">101</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol"</span>: <span class="string">"bluetooth"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">102</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"visitorConfig"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">103</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"characteristicUUID"</span>: <span class="string">"f000aa6604514000b000000000000000"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">104</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataConverter"</span>: &#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">105</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">106</span></pre></td><td class="code"><pre><span class="line">	&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">107</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"io-data-initialize"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">108</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"propertyName"</span>: <span class="string">"io-data-initialize"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">109</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"modelName"</span>: <span class="string">"cc2650-sen"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">110</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol"</span>: <span class="string">"bluetooth"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">111</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"visitorConfig"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">112</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"characteristicUUID"</span>: <span class="string">"f000aa6504514000b000000000000000"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">113</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataConverter"</span>: &#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">114</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">115</span></pre></td><td class="code"><pre><span class="line">	&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">116</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"io-config"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">117</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"propertyName"</span>: <span class="string">"io-config"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">118</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"modelName"</span>: <span class="string">"cc2650-sen"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">119</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol"</span>: <span class="string">"bluetooth"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">120</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"visitorConfig"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">121</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"characteristicUUID"</span>: <span class="string">"f000aa6604514000b000000000000000"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">122</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataConverter"</span>: &#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">123</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">124</span></pre></td><td class="code"><pre><span class="line">	&#125;, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">125</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"name"</span>: <span class="string">"io-data"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">126</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"propertyName"</span>: <span class="string">"io-data"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">127</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"modelName"</span>: <span class="string">"cc2650-sen"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">128</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"protocol"</span>: <span class="string">"bluetooth"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">129</span></pre></td><td class="code"><pre><span class="line">		<span class="attr">"visitorConfig"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">130</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"characteristicUUID"</span>: <span class="string">"f000aa6504514000b000000000000000"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">131</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataWrite"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">132</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"Buzzer"</span>: <span class="string">"BA=="</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">133</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"BuzzerGreen"</span>: <span class="string">"Bg=="</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">134</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"BuzzerRed"</span>: <span class="string">"BQ=="</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">135</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"BuzzerRedGreen"</span>: <span class="string">"Bw=="</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">136</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"Green"</span>: <span class="string">"Ag=="</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">137</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"Red"</span>: <span class="string">"AQ=="</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">138</span></pre></td><td class="code"><pre><span class="line">				<span class="attr">"RedGreen"</span>: <span class="string">"Aw=="</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">139</span></pre></td><td class="code"><pre><span class="line">			&#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">140</span></pre></td><td class="code"><pre><span class="line">			<span class="attr">"dataConverter"</span>: &#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">141</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">142</span></pre></td><td class="code"><pre><span class="line">	&#125;]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">143</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>读取上述文件后，根据配置文件，可以直接初始化mqtt、Schedular和Watcher；根据configmap文件也可以初始化设备的ID和名称（两者可以同值）。到此为止，BleConfig中就剩下了ActionManager和Converter还没有初始化了。</p>
<h5 id="2-3-Load函数（二）"><a href="#2-3-Load函数（二）" class="headerlink" title="2.3. Load函数（二）"></a>2.3. Load函数（二）</h5><p>2.2中省略部分的代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1、分别初始化ActionManager中的每一个动作</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span> _, actionConfig := <span class="keyword">range</span> readConfigFile.ActionManager.Actions &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 1-1、创建action，直接初始化action.Name和action.PerformImmediately</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">		action := actionmanager.Action&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">		action.Name = actionConfig.Name</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">		action.PerformImmediately = actionConfig.PerformImmediately</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 1-2、根据configmap文件里的propertyVistor（属性访问）字段进行初始化</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">for</span> _, propertyVisitor := <span class="keyword">range</span> readConfigMap.PropertyVisitors &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">if</span> strings.EqualFold(propertyVisitor.ModelName, b.Device.Name) &amp;&amp; strings.EqualFold(propertyVisitor.PropertyName, actionConfig.PropertyName) &amp;&amp; strings.ToUpper(propertyVisitor.Protocol) == ProtocolName &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">				propertyVisitorBytes, err := json.Marshal(propertyVisitor.VisitorConfig)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">					<span class="keyword">return</span> errors.New(<span class="string">"Error in marshalling data property visitor configuration: "</span> + err.Error())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">				&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">				bluetoothPropertyVisitor := VisitorConfigBluetooth&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">				err = json.Unmarshal(propertyVisitorBytes, &amp;bluetoothPropertyVisitor)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">					<span class="keyword">return</span> errors.New(<span class="string">"Error in unmarshalling data property visitor configuration: "</span> + err.Error())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">				&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 1-2-1、初始化action.Operation.CharacteristicUUID</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">				action.Operation.CharacteristicUUID = bluetoothPropertyVisitor.CharacteristicUUID</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">				newBluetoothVisitorConfig := VisitorConfigBluetooth&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">				<span class="keyword">if</span> !reflect.DeepEqual(bluetoothPropertyVisitor.BluetoothDataConverter, newBluetoothVisitorConfig.BluetoothDataConverter) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">					<span class="comment">// 1-2-2、初始化Converter.ReadAction中的各个字段</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">          readAction := dataconverter.ReadAction&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">					readAction.ActionName = actionConfig.Name</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">					readAction.ConversionOperation.StartIndex = bluetoothPropertyVisitor.BluetoothDataConverter.StartIndex</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">					readAction.ConversionOperation.EndIndex = bluetoothPropertyVisitor.BluetoothDataConverter.EndIndex</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">					readAction.ConversionOperation.ShiftRight = bluetoothPropertyVisitor.BluetoothDataConverter.ShiftRight</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">					readAction.ConversionOperation.ShiftLeft = bluetoothPropertyVisitor.BluetoothDataConverter.ShiftLeft</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">					<span class="keyword">for</span> _, readOperations := <span class="keyword">range</span> bluetoothPropertyVisitor.BluetoothDataConverter.OrderOfOperations &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">						readAction.ConversionOperation.OrderOfExecution = <span class="built_in">append</span>(readAction.ConversionOperation.OrderOfExecution, readOperations.BluetoothOperationType)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">						<span class="keyword">switch</span> strings.ToUpper(readOperations.BluetoothOperationType) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">						<span class="keyword">case</span> strings.ToUpper(BluetoothAdd):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">							readAction.ConversionOperation.Add = readOperations.BluetoothOperationValue</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">						<span class="keyword">case</span> strings.ToUpper(BluetoothSubtract):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">							readAction.ConversionOperation.Subtract = readOperations.BluetoothOperationValue</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">						<span class="keyword">case</span> strings.ToUpper(BluetoothMultiply):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">							readAction.ConversionOperation.Multiply = readOperations.BluetoothOperationValue</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">						<span class="keyword">case</span> strings.ToUpper(BluetoothDivide):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">							readAction.ConversionOperation.Divide = readOperations.BluetoothOperationValue</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">						&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">					&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">					b.Converter.DataRead.Actions = <span class="built_in">append</span>(b.Converter.DataRead.Actions, readAction)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">				&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">				<span class="keyword">if</span> bluetoothPropertyVisitor.DataWriteToBluetooth != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">          <span class="comment">// 1-2-3、初始化Converter.WriteAttribute中的各个字段，数据转换器初始化完成</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">					writeAttribute := dataconverter.WriteAttribute&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">					writeAttribute.Operations = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]dataconverter.DataMap, <span class="number">1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">					dataMap := dataconverter.DataMap&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">					dataMap.DataMapping = bluetoothPropertyVisitor.DataWriteToBluetooth</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">					writeAttribute.Operations[actionConfig.Name] = dataMap</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">					writeAttribute.Name = propertyVisitor.PropertyName</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">					b.Converter.DataWrite.Attributes = <span class="built_in">append</span>(b.Converter.DataWrite.Attributes, writeAttribute)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">				&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">			&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 1-3、根据configmap文件中的设备模型进行初始化</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">for</span> _, deviceModel := <span class="keyword">range</span> readConfigMap.DeviceModels &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">if</span> strings.EqualFold(deviceModel.Name, b.Device.Name) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">				<span class="keyword">for</span> _, property := <span class="keyword">range</span> deviceModel.Properties &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">					<span class="keyword">if</span> strings.EqualFold(property.Name, actionConfig.PropertyName) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">						<span class="keyword">if</span> property.AccessMode == READWRITE &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">							action.Operation.Action = <span class="string">"Write"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">							<span class="keyword">if</span> strings.ToUpper(property.DataType) == <span class="string">"INT"</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">								value := <span class="keyword">string</span>(<span class="keyword">int</span>(property.DefaultValue.(<span class="keyword">float64</span>)))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">								action.Operation.Value = []<span class="keyword">byte</span>(value)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">							&#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.ToUpper(property.DataType) == <span class="string">"STRING"</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">								<span class="keyword">for</span> _, converterAttribute := <span class="keyword">range</span> b.Converter.DataWrite.Attributes &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">									<span class="keyword">if</span> strings.EqualFold(converterAttribute.Name, actionConfig.PropertyName) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">										<span class="keyword">for</span> operationName, dataMap := <span class="keyword">range</span> converterAttribute.Operations &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">											<span class="keyword">if</span> action.Name == operationName &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">												<span class="keyword">if</span> _, ok := dataMap.DataMapping[property.DefaultValue.(<span class="keyword">string</span>)]; ok &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">													action.Operation.Value = dataMap.DataMapping[property.DefaultValue.(<span class="keyword">string</span>)]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">												&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">											&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">										&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">									&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">								&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">							&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">						&#125; <span class="keyword">else</span> <span class="keyword">if</span> property.AccessMode == READ &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">							action.Operation.Action = <span class="string">"Read"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">						&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">					&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">				&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">			&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">		b.ActionManager.Actions = <span class="built_in">append</span>(b.ActionManager.Actions, action)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr></table></figure>

<p>对于动作的初始化，名称和立即执行字段都可以直接初始化。</p>
<p>在第一个for循环中，根据PropertyVisitors字段初始化特征值UUID和数据转换器。特征UUID对应设备模型字段spec.propertyVisitors.bluetooth.characteristicUUID，数据转换，则对应设备模型字段spec.propertyVisitors.bluetooth.dataConverter。</p>
<p>在第二个for循环中，根据configmap文件的DeviceModels.deviceModel.property属性字段，初始化action.Operation.Action字段（Read和ReadWrite两种值）和action.Operation.Value字段（INT/STRING两种格式）。</p>
<p>最后，将初始化好的action加入到BleConfig的ActionManager的动作数组。待所有的action都放入后，将其作为一个全局变量。</p>
<p>接下来，回到main()函数，根据BleConfig初始化bleController并将其启动。</p>
<h5 id="2-4-启动bleController"><a href="#2-4-启动bleController" class="headerlink" title="2.4. 启动bleController"></a>2.4. 启动bleController</h5><h6 id="2-4-1-总览"><a href="#2-4-1-总览" class="headerlink" title="2.4.1. 总览"></a>2.4.1. 总览</h6><p>启动函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Start starts the controller of the mapper</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Config)</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 1、初始化TopicMap，就是初始化Mqtt对某些Topic的处理函数，用于通过Mqtt发布来在运行时更新配置</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   c.initTopicMap()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 2、通过配置文件信息连接到Mqtt并订阅1里注册的所有Topic</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   helper.MqttConnect(c.Mqtt.Mode, c.Mqtt.InternalServer, c.Mqtt.Server)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   subscribeAllTopics()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// *这一句用了sync.Waitgroup，在Start()函数尾等待所有任务完结</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   helper.ControllerWg.Add(<span class="number">1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 3、通过开源的gatt新建一个外设</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   device, err := gatt.NewDevice(option.DefaultClientOptions...)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">      klog.Fatalf(<span class="string">"Failed to open device, err: %s\n"</span>, err)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 4、通过之前的配置文件将这个外设初始化到watcher</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">go</span> c.Watcher.Initiate(device, c.Device.Name, c.Device.ID, c.ActionManager.Actions, c.Converter)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 5、当外设连接上之后，如果需要立即执行就立即执行一次</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">   &lt;-watcher.DeviceConnected</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">for</span> _, action := <span class="keyword">range</span> c.ActionManager.Actions &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> action.PerformImmediately &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">         action.PerformOperation(c.Converter.DataRead)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 6、按时执行</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">for</span> _, schedule := <span class="keyword">range</span> c.Scheduler.Schedules &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">      helper.ControllerWg.Add(<span class="number">1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">go</span> schedule.ExecuteSchedule(c.ActionManager.Actions, c.Converter.DataRead, c.Device.ID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">   helper.ControllerWg.Wait()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>第一步初始化了下列处理函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// initTopicMap initializes topics to their respective handler functions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Config)</span> <span class="title">initTopicMap</span><span class="params">()</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   topicMap[MapperTopicPrefix+c.Device.ID+WatcherTopicSuffix] = c.handleWatchMessage</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   topicMap[MapperTopicPrefix+c.Device.ID+SchedulerCreateTopicSuffix] = c.handleScheduleCreateMessage</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   topicMap[MapperTopicPrefix+c.Device.ID+SchedulerDeleteTopicSuffix] = c.handleScheduleDeleteMessage</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   topicMap[MapperTopicPrefix+c.Device.ID+ActionManagerCreateTopicSuffix] = c.handleActionCreateMessage</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   topicMap[MapperTopicPrefix+c.Device.ID+ActionManagerDeleteTopicSuffix] = c.handleActionDeleteMessage</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>包括监视、调度器的创建和删除、动作的创建和删除。</p>
<p>第二步根据mqtt的配置建立连接，并订阅了topicmap中的所有主题，并对ControllerWg + 1。</p>
<p>第三步中，利用了github上的gatt包，它是用于编写Ble外围设备和中央设备的协议。其中外围设备，在此处也就是边缘设备，可以创建服务，特征和描述符，发布，接受连接以及处理请求；中央设备，在此处也就是边缘节点，可以扫描，连接，发现服务并提出请求。本文不对其多加分析，可以参考<a href="https://github.com/paypal/gatt。这里就和设备建立起了连接。此处可参考3.2" target="_blank" rel="noopener">https://github.com/paypal/gatt。这里就和设备建立起了连接。此处可参考3.2</a>. Bug总结。</p>
<p>第四步，将设备初始化到监视器，具体如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Initiate initiates the watcher module</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Watcher)</span> <span class="title">Initiate</span><span class="params">(device gatt.Device, nameOfDevice, idOfDevice <span class="keyword">string</span>, actions []actionmanager.Action, converter dataconverter.Converter)</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   deviceID = idOfDevice</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   deviceName = nameOfDevice</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   actionManager = actions</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   dataConverter = converter</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 注册处理程序</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   device.Handle(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      gatt.PeripheralConnected(w.onPeripheralConnected),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">      gatt.PeripheralDisconnected(onPeripheralDisconnected),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">      gatt.PeripheralDiscovered(onPeripheralDiscovered),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">   )</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 注册边缘设备变化时执行的操作</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">   device.Init(onStateChanged)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">   &lt;-done</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">   klog.Infof(<span class="string">"Watcher Done"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>监视器给设备注册了三个处理函数，分别处理连接建立、停止连接和设备发现事件，并且注册了边缘设备变化时执行的操作，用于扫描设备和停止扫描。</p>
<h6 id="2-4-2-设备发现"><a href="#2-4-2-设备发现" class="headerlink" title="2.4.2. 设备发现"></a>2.4.2. 设备发现</h6><p>设备发现事件处理函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">onPeripheralDiscovered</span><span class="params">(p gatt.Peripheral, a *gatt.Advertisement, rssi <span class="keyword">int</span>)</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> strings.EqualFold(a.LocalName, strings.Replace(deviceName, <span class="string">"-"</span>, <span class="string">" "</span>, <span class="number">-1</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">      klog.Infof(<span class="string">"Device: %s found !!!! Stop Scanning for devices"</span>, deviceName)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Stop scanning once we've got the peripheral we're looking for.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      p.Device().StopScanning()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">      klog.Infof(<span class="string">"Connecting to %s"</span>, deviceName)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      p.Device().Connect(p)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这里是通过设备的本地名称和配置名称进行对比确认是否是要找的设备的，参考3.2. Bug总结。</p>
<h6 id="2-4-3-连接建立"><a href="#2-4-3-连接建立" class="headerlink" title="2.4.3. 连接建立"></a>2.4.3. 连接建立</h6><p>设备连接建立事件处理函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//onPeripheralConnected contains the operations to be performed as soon as the peripheral device is connected</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Watcher)</span> <span class="title">onPeripheralConnected</span><span class="params">(p gatt.Peripheral, err error)</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   actionmanager.GattPeripheral = p</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   ss, err := p.DiscoverServices(<span class="literal">nil</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">      klog.Errorf(<span class="string">"Failed to discover services, err: %s\n"</span>, err)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      os.Exit(<span class="number">1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">for</span> _, s := <span class="keyword">range</span> ss &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Discovery characteristics</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">      cs, err := p.DiscoverCharacteristics(<span class="literal">nil</span>, s)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">         klog.Errorf(<span class="string">"Failed to discover characteristics for service %s, err: %v\n"</span>, s.Name(), err)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">continue</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      actionmanager.CharacteristicsList = <span class="built_in">append</span>(actionmanager.CharacteristicsList, cs...)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">   DeviceConnected &lt;- <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">for</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">      newWatcher := &amp;Watcher&#123;&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> !reflect.DeepEqual(w, newWatcher) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">         err := w.EquateTwinValue(deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            klog.Errorf(<span class="string">"Error in watcher functionality: %s"</span>, err)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">         &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>在成功建立连接后，扫描设备所有的service，并将特征值存储到动作管理器中的特征列表，这个特征值包含了UUID。并且如果watcher非空，会运行EquateTwinValue函数，将设备实际状态与期望状态同步，并同步给云端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//EquateTwinValue is responsible for equating the actual state of the device to the expected state that has been set and syncing back the result to the cloud</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Watcher)</span> <span class="title">EquateTwinValue</span><span class="params">(deviceID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">//1-1、构建设备twin更新消息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> updateMessage helper.DeviceTwinUpdate</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   updatedActualValues := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">//1-2、Wg+1，会在TwinSubscribe中完成</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   helper.Wg.Add(<span class="number">1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   klog.Infof(<span class="string">"Watching on the device twin values for device with deviceID: %s"</span>, deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">//1-3、订阅twin的消息，topic = $hw/events/device/&lt;deviceID&gt;/twin/get/result，接收到后将消息放到helper.TwinResult，将每一个twin放到helper.TwinAttributes数组</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">go</span> helper.TwinSubscribe(deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">//1-4、将updateMessage通过topic = $hw/events/device/&lt;deviceID&gt;/twin/get发布</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">   helper.GetTwin(updateMessage, deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">//1-5、等待订阅到twin消息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">   helper.Wg.Wait()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">   twinUpdated := <span class="literal">false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">//2、对于初始化的watcher中的twinAttribute</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">for</span> _, twinAttribute := <span class="keyword">range</span> w.DeviceTwinAttributes &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//2-1、如果包含在1-3中接收到的twin消息中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> helper.TwinResult.Twin[twinAttribute.Name] != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">         <span class="comment">//2-1-1、如果期望非空实际为空或者期望值与实际值不符</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">if</span> helper.TwinResult.Twin[twinAttribute.Name].Expected != <span class="literal">nil</span> &amp;&amp; ((helper.TwinResult.Twin[twinAttribute.Name].Actual == <span class="literal">nil</span>) &amp;&amp; helper.TwinResult.Twin[twinAttribute.Name].Expected != <span class="literal">nil</span> || (*helper.TwinResult.Twin[twinAttribute.Name].Expected.Value != *helper.TwinResult.Twin[twinAttribute.Name].Actual.Value)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            klog.Infof(<span class="string">"%s Expected Value : %s"</span>, twinAttribute.Name, *helper.TwinResult.Twin[twinAttribute.Name].Expected.Value)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> helper.TwinResult.Twin[twinAttribute.Name].Actual == <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">               klog.Infof(<span class="string">"%s  Actual Value: %v"</span>, twinAttribute.Name, helper.TwinResult.Twin[twinAttribute.Name].Actual)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">               klog.Infof(<span class="string">"%s Actual Value: %s"</span>, twinAttribute.Name, *helper.TwinResult.Twin[twinAttribute.Name].Actual.Value)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            klog.Infof(<span class="string">"Equating the actual value to expected value for: %s"</span>, twinAttribute.Name)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//2-1-1-1、对应的每一个动作，先判断动作管理器中是否存在该动作，再找到符合期望的写入值作为动作的值，执行这一动作</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">for</span> _, watcherAction := <span class="keyword">range</span> twinAttribute.Actions &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">               actionExists := <span class="literal">false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">               <span class="keyword">for</span> _, action := <span class="keyword">range</span> actionManager &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">                  <span class="keyword">if</span> strings.EqualFold(action.Name, watcherAction) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">                     actionExists = <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">                     <span class="keyword">for</span> _, converterAttribute := <span class="keyword">range</span> dataConverter.DataWrite.Attributes &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">                        <span class="keyword">if</span> strings.EqualFold(converterAttribute.Name, twinAttribute.Name) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">                           <span class="keyword">for</span> operationName, dataMap := <span class="keyword">range</span> converterAttribute.Operations &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">                              <span class="keyword">if</span> action.Name == operationName &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">                                 expectedValue := helper.TwinResult.Twin[twinAttribute.Name].Expected.Value</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">                                 <span class="keyword">if</span> _, ok := dataMap.DataMapping[*expectedValue]; ok &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">                                    action.Operation.Value = dataMap.DataMapping[*expectedValue]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">                                 &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">                              &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">                              action.PerformOperation()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">                           &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">                        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">                     &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">                  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">               &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">               <span class="keyword">if</span> !actionExists &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">                  <span class="keyword">return</span> errors.New(<span class="string">"The action: "</span> + watcherAction + <span class="string">" does not exist for this device"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">               &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//2-1-1-2、准备同步、更新</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">            updatedActualValues[twinAttribute.Name] = *helper.TwinResult.Twin[twinAttribute.Name].Expected.Value</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">            twinUpdated = <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">         &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">      &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">return</span> errors.New(<span class="string">"The attribute: "</span> + twinAttribute.Name + <span class="string">" does not exist for this device"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">//3、如果需要更新</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> twinUpdated &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//3-1、创建twin更新消息，包含twin实际值</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">      updateMessage = helper.CreateActualUpdateMessage(updatedActualValues)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//3-2、将twin更新消息发布到topic = $hw/events/device/&lt;deviceID&gt;/twin/update</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">      helper.ChangeTwinValue(updateMessage, deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">      time.Sleep(<span class="number">2</span> * time.Second)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">      klog.Infof(<span class="string">"Syncing to cloud....."</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//3-3、将twin更新消息发布到topic = $hw/events/device/&lt;deviceID&gt;/twin/cloud_updated</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">      helper.SyncToCloud(updateMessage, deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">   &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">      klog.Infof(<span class="string">"Actual values are in sync with Expected value"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这里主要是对于期望值实际值不符的twin进行更新。</p>
<p>断开连接的处理函数和设备扫描不再细讲，可以参考paypal/gatt项目，至此，Watcher初始化完成。</p>
<h6 id="2-4-4-动作执行"><a href="#2-4-4-动作执行" class="headerlink" title="2.4.4. 动作执行"></a>2.4.4. 动作执行</h6><p>第五步，当主函数接收到设备连接的消息后，扫描该设备的每一个动作，如果PerformImmediately字段为真，就立即执行一次。具体如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//PerformOperation executes the operation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(action *Action)</span> <span class="title">PerformOperation</span><span class="params">(readConverter ...dataconverter.DataRead)</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   klog.Infof(<span class="string">"Performing operations associated with action:  %s"</span>, action.Name)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 1、获取要读/写的UUID</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   characteristic, err := FindCharacteristic(action.Operation.CharacteristicUUID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      klog.Errorf(<span class="string">"Error in finding characteristics: %s"</span>, err)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 2、如果是读操作，读取寄存器里的值，如果需要转换的话则进行转换</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> strings.ToUpper(action.Operation.Action) == ActionRead &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">      readValue, err := ReadCharacteristic(GattPeripheral, characteristic)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">         klog.Errorf(<span class="string">"Error in reading  characteristic: %s"</span>, err)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">return</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      converted := <span class="literal">false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> _, conversionAction := <span class="keyword">range</span> readConverter[<span class="number">0</span>].Actions &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">if</span> strings.EqualFold(conversionAction.ActionName, action.Name) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            convertedValue := fmt.Sprintf(<span class="string">"%f"</span>, conversionAction.ConversionOperation.ConvertReadData(readValue))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            action.Operation.Value = []<span class="keyword">byte</span>(convertedValue)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            converted = <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">         &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> !converted &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">         action.Operation.Value = readValue</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">      klog.Info(<span class="string">"Read Successful"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 3、如果是写操作，则将待写入的值写入到寄存器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.ToUpper(action.Operation.Action) == ActionWrite &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> action.Operation.Value == <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">         klog.Errorf(<span class="string">"Please provide a value to be written"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">return</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">      err := WriteCharacteristic(GattPeripheral, characteristic, action.Operation.Value)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">         klog.Errorf(<span class="string">"Error in writing characteristic: %s"</span>, err)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">return</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">      klog.Info(<span class="string">"Write Successful"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>2.4.5. </p>
<p>最后，调度器将需要按时执行的动作创建协程定时执行，并且在所有调度器执行完成之前不会停止（可能无限执行）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExecuteSchedule is responsible for scheduling the operations</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(schedule *Schedule)</span> <span class="title">ExecuteSchedule</span><span class="params">(actionManager []actionmanager.Action, dataConverter dataconverter.DataRead, deviceID <span class="keyword">string</span>)</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   klog.Infof(<span class="string">"Executing schedule: %s"</span>, schedule.Name)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> schedule.OccurrenceLimit != <span class="number">0</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> iteration := <span class="number">0</span>; iteration &lt; schedule.OccurrenceLimit; iteration++ &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">         schedule.performScheduleOperation(actionManager, dataConverter, deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">         schedule.performScheduleOperation(actionManager, dataConverter, deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">   helper.ControllerWg.Done()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>函数中根据之前配置文件中的occurrence-limit字段判断执行次数，具体的执行函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// performScheduleOperation is responsible for performing the operations associated with the schedule</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(schedule *Schedule)</span> <span class="title">performScheduleOperation</span><span class="params">(actionManager []actionmanager.Action, dataConverter dataconverter.DataRead, deviceID <span class="keyword">string</span>)</span></span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> scheduleResult ScheduleResult</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   actionExists := <span class="literal">false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">for</span> _, actionName := <span class="keyword">range</span> schedule.Actions &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> _, action := <span class="keyword">range</span> actionManager &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">if</span> strings.EqualFold(action.Name, actionName) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            actionExists = <span class="literal">true</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            klog.Infof(<span class="string">"Performing scheduled operation: %s"</span>, action.Name)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            action.PerformOperation(dataConverter)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            scheduleResult.EventName = actionName</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            scheduleResult.TimeStamp = time.Now().UnixNano() / <span class="number">1e6</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            scheduleResult.EventResult = fmt.Sprintf(<span class="string">"%s"</span>, action.Operation.Value)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            publishScheduleResult(scheduleResult, deviceID)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">         &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> schedule.Interval == <span class="number">0</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">         schedule.Interval = defaultEventFrequency</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> !actionExists &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">         klog.Errorf(<span class="string">"Action %s does not exist. Exiting from schedule !!!"</span>, actionName)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">         <span class="keyword">break</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">      time.Sleep(time.Duration(time.Duration(schedule.Interval) * time.Millisecond))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>执行函数对于调度器中的所有动作执行一次，并将结果发布到了topic = $ke/device/bluetooth-mapper/&lt;deviceID&gt;/scheduler/result，下面是一个结果消息的例子：<code>{&quot;EventName&quot;:&quot;IRTemperatureData&quot;,&quot;TimeStamp&quot;:1590715568239,&quot;EventResult&quot;:&quot;511.968750&quot;}</code>。</p>
<p>这样，BlueToothMapper各部分的分析就完成了。</p>
<h4 id="3-小结"><a href="#3-小结" class="headerlink" title="3. 小结"></a>3. 小结</h4><h5 id="3-1-消息流总结"><a href="#3-1-消息流总结" class="headerlink" title="3.1. 消息流总结"></a>3.1. 消息流总结</h5><p>在蓝牙Mapper中，有三个主要的消息流：第一，用户可以通过发布Mqtt主题的方式，增删监视器、调度器和动作，而Controller订阅了这几个主题的mqtt消息，当收到消息后就可以根据用户的需求调用处理函数进行修改；第二，Watcher消息流，它主要监视twin消息，当twin消息的期望值与实际值不符时，执行相应的写动作调整到一致，并发布更新消息和同步消息；第三，Scheduler消息，定时执行动作，并将结果发布。</p>
<h5 id="3-2-Bug总结"><a href="#3-2-Bug总结" class="headerlink" title="3.2. Bug总结"></a>3.2. Bug总结</h5><p>目前，由于BluetoothMapper很久没更新了，加之其引用的paypal/gatt包过于老旧，可能引起一些难以预料的bug，笔者就遇到了以下问题：</p>
<ul>
<li>在paypal/gatt包的adv.go文件99行，由于缺少判断，可能出现<code>d := b[2 : 1]</code>的问题，如果遇到的话，需要添加对<code>l</code>值的判断，防止切片错误</li>
<li>由于BluetoothMappe要通过设备的Local Name判断是否是目标设备，在连接前需要先判断设备的Local Name是否符合预期，笔者的CentOS虚拟机会自动将较长的设备Local Name剪短，导致和预期不匹配无法连接。可以通过<code>hcitool lescan</code>先找到自己的蓝牙设备，判断Local Name</li>
</ul>
<h5 id="3-3-问题总结"><a href="#3-3-问题总结" class="headerlink" title="3.3. 问题总结"></a>3.3. 问题总结</h5><p>在实践过程中，笔者也遇到了一些问题，欢迎大家一起探讨：</p>
<ul>
<li>根据源码分析，对于只读类型的值，比如温度传感器监测到的温度，理论上应该在Scheduler拿到数据后发布给Eventbus，但是$ke/device/bluetooth-mapper/&lt;deviceID&gt;/scheduler/result这个topic及对应的消息格式似乎并没有被任何组件接收</li>
</ul>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>RongAI
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="/http:/www.t4l2.com/2020-05-19-KubeEdge%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BBluetoothMapper.html" title="KubeEdge源码分析之BluetoothMapper">http://www.t4l2.com/2020-05-19-KubeEdge源码分析之BluetoothMapper.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/kubeedge/" rel="tag"><i class="fa fa-tag"></i> kubeedge</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020-04-24-KubeEdge%E4%BA%91%E7%AB%AF%E6%B6%88%E6%81%AF%E6%B5%81.html" rel="prev" title="KubeEdge云端消息流">
      <i class="fa fa-chevron-left"></i> KubeEdge云端消息流
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#0-引言"><span class="nav-text">0. 引言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-整体分析"><span class="nav-text">1. 整体分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Main-函数"><span class="nav-text">2. Main()函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1-BleConfig结构"><span class="nav-text">2.1. BleConfig结构</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-1-1-ActionManager"><span class="nav-text">2.1.1. ActionManager</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-1-2-Scheduler"><span class="nav-text">2.1.2. Scheduler</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-1-3-Watcher"><span class="nav-text">2.1.3. Watcher</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-1-4-Converter"><span class="nav-text">2.1.4. Converter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-1-5-Device"><span class="nav-text">2.1.5. Device</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-1-6-Mqtt"><span class="nav-text">2.1.6. Mqtt</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-Load函数（一）"><span class="nav-text">2.2. Load函数（一）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-Load函数（二）"><span class="nav-text">2.3. Load函数（二）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-启动bleController"><span class="nav-text">2.4. 启动bleController</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-1-总览"><span class="nav-text">2.4.1. 总览</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-2-设备发现"><span class="nav-text">2.4.2. 设备发现</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-3-连接建立"><span class="nav-text">2.4.3. 连接建立</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-4-4-动作执行"><span class="nav-text">2.4.4. 动作执行</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-小结"><span class="nav-text">3. 小结</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-消息流总结"><span class="nav-text">3.1. 消息流总结</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-Bug总结"><span class="nav-text">3.2. Bug总结</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-问题总结"><span class="nav-text">3.3. 问题总结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="RongAI"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">RongAI</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/majoyz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;majoyz" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzmj@outlook.com" title="E-Mail → mailto:imzmj@outlook.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">RongAI</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
